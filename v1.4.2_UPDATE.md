# 🚀 v1.4.2 更新 - 下载功能全面改进

## 📋 更新内容

### ✨ 核心改进

1. **详细错误诊断**
   - ✅ 每个资源显示完整的下载状态
   - ✅ HTTP 状态码日志
   - ✅ 详细错误原因（最多20条）
   - ✅ 实际下载字节数

2. **Cookie 和认证支持**
   - ✅ 自动从抓取窗口获取 cookies
   - ✅ 在所有下载请求中包含 cookies
   - ✅ 支持需要登录的游戏资源

3. **完整的请求头**
   ```javascript
   User-Agent: Chrome 120
   Accept: */*
   Accept-Encoding: gzip, deflate, br
   Accept-Language: zh-CN,zh;q=0.9
   Referer: 游戏URL
   Origin: 游戏域名
   Cookie: 自动获取
   ```

4. **重试机制**
   - ✅ 网络错误自动重试（最多3次）
   - ✅ 递增延迟：1秒、2秒、3秒
   - ✅ 只对临时错误重试（ECONNRESET、ETIMEDOUT）

5. **URL 处理**
   - ✅ URL 解码（支持中文路径）
   - ✅ 处理相对路径重定向
   - ✅ 检测并拒绝无效 URL

6. **性能优化**
   - ✅ 并发数从5降至3（避免服务器限制）
   - ✅ 批次间延迟500ms
   - ✅ 超时从30秒延长至60秒
   - ✅ 批次进度显示

---

## 🔍 诊断下载失败的步骤

### 第1步：查看控制台日志

启动应用后，观察终端输出：

```bash
npm run electron:dev
```

**成功的日志**：
```
🚀 开始下载 114 个资源...

📦 批次 1/38
📥 正在下载: https://cdn.game.com/assets/images/bg.png
📊 响应状态: 200 - https://cdn.game.com/assets/images/bg.png
✅ 下载成功: assets/images/bg.png (45678 bytes)
```

**失败的日志**：
```
📥 正在下载: https://cdn.game.com/audio/bgm.mp3
📊 响应状态: 403 - https://cdn.game.com/audio/bgm.mp3
❌ HTTP 403 - https://cdn.game.com/audio/bgm.mp3
```

---

### 第2步：识别错误类型

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `HTTP 403` | 禁止访问/防盗链 | 确保在抓取窗口中已登录游戏 |
| `HTTP 404` | 资源不存在 | URL可能已失效 |
| `HTTP 401` | 需要认证 | 需要游戏登录状态 |
| `无效的URL: /xxx` | 相对路径 | 抓取到的是相对路径，无法下载 |
| `ENOTFOUND` | 域名无法解析 | URL格式错误或网络问题 |
| `ECONNREFUSED` | 连接被拒绝 | 服务器拒绝连接 |
| `ETIMEDOUT` | 请求超时 | 网络慢或文件太大 |
| `请求超时 (60s)` | 超过60秒未完成 | 文件过大或网络太慢 |

---

### 第3步：常见问题及解决

#### 问题1：大量 HTTP 403 错误

**现象**：
```
❌ HTTP 403 - https://cdn.game.com/xxx.png
❌ HTTP 403 - https://cdn.game.com/yyy.mp3
```

**原因**：防盗链检查

**解决方案**：
1. ⚠️ **保持抓取窗口打开**
   - 在下载前**不要关闭**抓取窗口
   - 抓取窗口关闭后，cookies会失效

2. ✅ **确保已登录**
   - 如果游戏需要登录，在抓取窗口中先登录
   - 登录后再开始抓取和下载

3. ✅ **立即下载**
   - 停止抓取后立即下载
   - 不要等待太久，token可能会过期

---

#### 问题2：无效的URL错误

**现象**：
```
❌ 无效的URL: /assets/images/bg.png
❌ 无效的URL: /res/audio/bgm.mp3
```

**原因**：抓取到的是相对路径，缺少域名

**当前限制**：v1.4.2 无法处理相对路径

**临时解决方案**：
这些资源可能是页面内嵌的，通常不重要，可以忽略。

**下一步改进**：
v1.5.0 将添加 base URL 拼接功能。

---

#### 问题3：ENOTFOUND 错误

**现象**：
```
❌ 网络错误: getaddrinfo ENOTFOUND cdn.game.com
```

**原因**：
1. URL中的域名无法解析
2. 可能是抓取时出错

**解决方案**：
1. 检查网络连接
2. 复制URL到浏览器测试
3. 如果浏览器也打不开，说明URL确实有问题

---

#### 问题4：所有资源都失败

**可能原因**：

1. **没有登录游戏**
   - 解决：在抓取窗口中先登录

2. **抓取窗口已关闭**
   - 解决：重新抓取，下载时保持窗口打开

3. **游戏使用特殊加密**
   - 某些游戏对资源进行了加密
   - 需要特殊的解密方法

4. **抓取到了相对路径**
   - 检查资源列表中的URL
   - 如果都是 `/xxx/xxx` 格式，说明是相对路径

---

## 💡 提高下载成功率的技巧

### 技巧1：抓取时完整操作游戏

```
开始抓取 → 登录游戏 → 浏览所有界面 → 进入关卡 → 停止抓取
```

确保：
- ✅ 已登录（如需要）
- ✅ 所有资源都加载过
- ✅ 不要关闭抓取窗口

### 技巧2：下载时机

**最佳时机**：停止抓取后**立即下载**

```
停止抓取 → 立即点击下载 → 等待完成
```

**不要**：
- ❌ 停止抓取后等待太久
- ❌ 先关闭抓取窗口再下载
- ❌ 下载过程中关闭应用

### 技巧3：分批下载

如果资源很多（100+），建议分批：

**第一批**：核心资源
```
勾选: 🎮 Cocos + 🦴 Spine
下载
```

**第二批**：媒体资源
```
勾选: 📷 图片 + 🎵 音频
下载
```

**第三批**：其他资源
```
勾选: 📝 脚本 + 📋 JSON + 📦 其他
下载
```

### 技巧4：检查已下载的资源

下载完成后，查看保存目录：

```
你的目录/
├── assets/
│   ├── images/     ← 检查图片是否正常
│   ├── audio/      ← 检查音频能否播放
│   └── spine/      ← 检查动画文件
```

**验证文件**：
- 图片：双击打开看是否正常
- 音频：播放器打开听是否正常
- 其他：查看文件大小（0字节说明失败）

---

## 🔧 调试方法

### 方法1：复制URL测试

1. 在资源列表中找一个失败的资源
2. 点击 📋 复制链接
3. 在浏览器中粘贴并打开
4. 观察结果：
   - ✅ 能打开 → 说明URL有效，是下载代码问题
   - ❌ 403错误 → 需要登录或防盗链
   - ❌ 404错误 → URL已失效

### 方法2：查看完整日志

控制台日志会显示：
```
✨ 下载完成！
📊 总计: 114, 成功: 5, 失败: 109

❌ 错误详情:
1. HTTP 403 - https://cdn.game.com/asset1.png
2. HTTP 403 - https://cdn.game.com/asset2.png
3. 无效的URL: /relative/path.png
...
```

**分析错误模式**：
- 如果都是 `HTTP 403` → 认证问题
- 如果都是 `无效的URL` → 相对路径问题
- 如果各种错误都有 → 多种问题混合

---

## 📊 成功案例参考

### 案例1：成功率 95%+

**用户反馈**：
```
总资源: 200
成功: 195
失败: 5
```

**操作步骤**：
1. 输入游戏URL并开始抓取
2. 在抓取窗口中登录游戏
3. 完整操作游戏（所有界面、关卡）
4. 停止抓取
5. **不关闭抓取窗口**
6. 立即选择资源并下载
7. 等待完成

**关键**：全程保持抓取窗口打开！

---

## 🆘 如果仍然大量失败

请提供以下信息：

### 1. 控制台日志

从 `🚀 开始下载` 到 `✨ 下载完成` 的**完整输出**

### 2. 失败资源URL

复制几个失败的资源URL，例如：
```
https://cdn.game.com/assets/xxx.png
https://api.game.com/res/yyy.mp3
```

### 3. 游戏信息

- 游戏URL：
- 是否需要登录：是/否
- 是否已登录：是/否
- 抓取窗口是否保持打开：是/否

### 4. 错误类型统计

例如：
```
HTTP 403: 90个
HTTP 404: 10个
无效URL: 9个
```

---

## 📝 下一步计划

如果 v1.4.2 的改进还不够，我将实现：

### v1.5.0 计划

1. **Base URL 拼接**
   - 自动拼接相对路径
   - 解决 "无效URL" 问题

2. **备选下载方法**
   - 使用 Electron 内置下载API
   - 在抓取窗口中直接下载
   - 100% 包含认证信息

3. **下载前预检**
   - 先测试 URL 可用性
   - 只下载有效的资源

4. **断点续传**
   - 支持中断后继续下载
   - 避免重复下载已有文件

---

**立即试用 v1.4.2！查看控制台日志，诊断具体问题！** 🚀
